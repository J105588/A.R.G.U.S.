# Network Monitor -Argus-

Network Monitorは、ローカルネットワーク上のHTTP/HTTPS通信を監視、分析、フィルタリングするためのPython製ウェブアプリケーションです。

バックエンドには`mitmproxy`の強力なプロキシ機能を、フロントエンドには`Flask`と`Socket.IO`を採用し、リアルタイムで通信状況を可視化します。特定のドメインやコンテンツキーワードに基づいて通信をブロックする機能も備えています。


## ライセンス

このプロジェクトは **[MITライセンス](https://opensource.org/licenses/MIT)** の下で公開されています。
使用、コピー、変更、マージ、出版、配布、サブライセンス、および/または販売を、制限なく誰にでも許可します。詳細はプロジェクトルートの`LICENSE`ファイルを参照してください。

## プロジェクトのゴール

このツールは、以下の目的で開発されました。

- **学習目的**: Web通信の仕組み（HTTP/HTTPSプロトコル、リクエスト/レスポンス構造）を実践的に学ぶ。
- **セキュリティ分析**: 家庭内ネットワークや開発環境において、アプリケーションが意図しないサーバーと通信していないか、不審なデータを送信していないかを調査する。
- **ペアレンタルコントロール**: 子供が利用する端末の通信を監視し、不適切なサイトやコンテンツへのアクセスを制限する。
- **デバッグ支援**: 開発中のWebアプリケーションやモバイルアプリのAPI通信を外部から確認し、デバッグを効率化する。

## 主な機能

- **リアルタイム通信監視**:
    - ネットワーク上を流れるHTTP/HTTPSリクエストをリアルタイムで捕捉し、ダッシュボードに表示します。
    - 通信量（リクエスト数、合計サイズ）の推移をグラフで可視化します。
    - 最近通信したドメイン、リクエストの多いドメインをランキング表示します。
- **柔軟なフィルタリング**:
    - **ドメインブロック**: 指定したドメイン（例: `example.com`）へのアクセスをブロックします。
    - **キーワードブロック**: レスポンスボディに含まれる特定のキーワード（例: `危険`, `広告`）を検出し、その通信をブロックします。
    - ブロックルールはWebインターフェースから動的に追加・削除が可能です。
- **詳細な通信ログ (mitmweb連携)**:
    - `mitmproxy`標準のWebインターフェース`mitmweb`と連携し、個別の通信リクエスト/レスポンスのヘッダーやボディを詳細に調査できます。
- **マルチデバイス対応**:
    - PCだけでなく、同じネットワークに接続されたスマートフォン（iPhone/Android）や他のPCの通信を監視することも可能です。
    - Web管理画面もレスポンシブデザインに対応しており、スマートフォンからアクセスして操作できます。

## 注意・免責事項

- **倫理的な使用**: このツールは強力な通信監視機能を提供します。使用者は、監視対象となるデバイスの所有者から明示的な許可を得るなど、プライバシーを尊重し、適用されるすべての法律および規制を遵守する責任を負います。他人の通信を無断で傍受・監視する行為は、法律で罰せられる可能性があります。
- **自己責任**: このツールの使用によって生じたいかなる損害（データの損失、セキュリティ侵害、法的問題など）についても、開発者は一切の責任を負いません。すべて自己の責任において使用してください。
- **セキュリティ**: このツールは開発および学習目的で作成されており、商用レベルの堅牢なセキュリティは保証されていません。インターネットに直接公開するような形での使用は避けてください。

## システム構成

- **プロキシサーバー**: `mitmproxy` (Python)
- **Webフレームワーク**: `Flask` (Python)
- **リアルタイム通信**: `Flask-SocketIO`
- **データベース**: `SQLite`
- **フロントエンド**: `HTML`, `CSS`, `JavaScript (Bootstrap, Chart.js, Socket.IO client)`

## セットアップ手順

### 1. 前提条件

- [Python 3.8](https://www.python.org/downloads/) 以上
- Windows OS

### 2. プロジェクトのダウンロードと展開

1.  このリポジトリのZIPファイルをダウンロードし、任意の場所に展開します。
    - 例: `C:\dev\network-monitor`

### 3. 初期設定バッチの実行

1.  展開したフォルダにある `setup.bat` を **右クリック**し、**「管理者として実行」** を選択します。
2.  スクリプトが実行され、以下の処理が自動的に行われます。
    - Pythonの仮想環境 (`venv`) の構築
    - 必要なPythonライブラリのインストール (`requirements.txt`に基づく)
    - 設定ファイルとデータベースディレクトリの作成

### 4. テンプレートファイルの作成 (手動)

`setup.bat`が正常に完了しなかった場合に備え、Webページの表示に必要なHTMLテンプレートファイルを手動で作成します。

1.  プロジェクト内の `templates` フォルダに移動します。
2.  以下の2つのファイルを新規作成し、指定された内容をそれぞれコピー＆ペーストしてください。（内容は前回の回答と同じため省略）
    - `layout.html`
    - `certificate.html`

## 使用方法

### 1. アプリケーションの起動

1.  プロジェクトフォルダにある `run.bat` を **右クリック**し、**「管理者として実行」** します。
    - HTTPS通信を解読するために証明書を生成・アクセスする権限が必要です。
2.  コマンドプロンプトに以下のようなメッセージが表示され、アプリケーションが起動します。
    ```
    Starting the application...
    Web Interface: http://localhost:8081
    Proxy Port:    8080 (default)
    Press Ctrl+C to stop the system.
    ========================================
    ...
     * Running on http://127.0.0.1:8081
     * Running on http://192.168.0.100:8081  <-- 他の端末からのアクセスに使うIP
    ```

### 2. PCの通信を監視する

#### 2.1. 証明書のインストール
HTTPS通信を監視するため、最初に一度だけ証明書をインストールします。

1.  ブラウザで `http://localhost:8081/certificate` にアクセスします。
2.  ページの手順に従い、`mitmproxy-ca-cert.cer` をダウンロードし、PCの**「信頼されたルート証明機関」**ストアにインストールします。
3.  インストール後、**必ずブラウザを再起動してください。**

#### 2.2. プロキシの設定
PCの通信が監視アプリケーションを経由するように設定します。

1.  Windowsの「設定」 → 「ネットワークとインターネット」 → 「プロキシ」を開きます。
2.  「プロキシ サーバーを使う」を**オン**にします。
3.  **IPアドレス**: `127.0.0.1`
4.  **ポート**: `8080`
5.  「保存」をクリックします。

設定後、ブラウザでウェブサイトにアクセスすると、Network Monitorのダッシュボード (`http://localhost:8081/dashboard`) に通信内容がリアルタイムで表示され始めます。

### 3. 他の端末（iPhoneなど）の通信を監視する

PCと監視したい端末が**同じWi-Fiネットワークに接続されている**必要があります。

#### 3.1. 証明書のインストール (監視したい端末側で操作)
1.  まず、上記 **2.2.** の手順でPCのプロキシを有効にしておきます。
2.  iPhoneのSafariで `http://mitm.it` にアクセスします。
3.  画面の指示に従い、証明書プロファイルをダウンロードしてインストールします。
4.  iPhoneの「設定」→「一般」→「情報」→「証明書信頼設定」を開き、`mitmproxy` のスイッチを**オン**にします。

#### 3.2. プロキシの設定 (監視したい端末側で操作)
1.  iPhoneの「設定」→「Wi-Fi」で、接続中のネットワークの詳細設定を開きます。
2.  一番下の「HTTPプロキシ」を「手動」に設定します。
    - **サーバ**: PCのIPアドレス (例: `run.bat`起動時に表示された `192.168.0.100`)
    - **ポート**: `8080`
3.  「保存」をタップします。

**注意**: 監視が不要になったら、PCやiPhoneのプロキシ設定は必ず**オフ**に戻してください。

## 応用的な使い方：mitmwebとの連携

Network Monitorの簡易ダッシュボードと並行して、`mitmproxy`公式の高機能なWebインターフェース`mitmweb`を使い、より詳細な通信ログを調査することができます。

1.  `run.bat` でNetwork Monitorを起動したままにします。
2.  **新しいコマンドプロンプト**を（管理者権限なしで）開きます。
3.  仮想環境を有効にします: `C:\dev\network-monitor\venv\Scripts\activate.bat`
4.  以下のコマンドで `mitmweb` を**サーバー無しモード**で起動します:
    ```cmd
    mitmweb --web-port 8082 --no-server
    ```
5.  ブラウザで以下にアクセスします。
    - **Network Monitor**: `http://localhost:8081`
    - **mitmweb 詳細ログ**: `http://localhost:8082`

## ディレクトリ構成

```
network-monitor/
│
├── .venv/                   - Python仮想環境
├── config/                  - 設定ファイル用ディレクトリ
│   ├── blocked_domains.txt  - ブロックするドメインのリスト
│   └── blocked_keywords.txt - ブロックするキーワードのリスト
├── data/                    - データファイル用ディレクトリ
│   └── network_stats.db     - 通信統計情報を保存するSQLiteデータベース
├── src/                     - ソースコードディレクトリ
│   ├── monitor.py           - mitmproxyのメインスクリプト（通信傍受・処理）
│   ├── web_interface.py     - FlaskのWebアプリケーション（ダッシュボード・API）
│   └── utils.py             - データベース操作などのユーティリティ関数
├── static/                  - CSS, JavaScriptなどの静的ファイル
│   ├── css/
│   └── js/
├── templates/               - HTMLテンプレートファイル
│   ├── dashboard.html       - ダッシュボードページ
│   ├── index.html           - トップページ
│   ├── settings.html        - 設定ページ
│   ├── certificate.html     - 証明書インストール案内ページ
│   └── layout.html          - 全ページの共通レイアウト
│
├── requirements.txt         - 必要なPythonライブラリのリスト
├── run.bat                  - アプリケーション起動用バッチファイル
└── setup.bat                - 初期セットアップ用バッチファイル
```


## トラブルシューティング

- **他の端末から管理画面にアクセスできない**:
    - PCの**Windows Defender ファイアウォール**が原因である可能性が高いです。「ファイアウォールとネットワーク保護」設定で、アクティブなネットワークのファイアウォールを一時的にオフにして接続を試みてください。接続が確認できたら、セキュリティのためファイアウォールを再度有効にし、「ファイアウォールによるアプリケーションの許可」で`python.exe`の受信規則を許可することをお勧めします。



